<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="css/styler.css">
        <script src="/node_modules/jquery/dist/jquery.js"></script>
        <script src="/node_modules/chart.js/dist/Chart.js"></script>
    </head>
    <body>
        <script>
            var username = sessionStorage.getItem("username");
            var password = sessionStorage.getItem("password");
            var typer = "login";

            //call backend to make sure this username and password exists. 
            //if (!backend()) 
            $.ajax({
                    url: "/login",
                    type: "POST", 
                    dataType: 'html', 
                    data: { username: username, password: password, type: typer}, 
                    success: function(result)
                    { 
                        if (result == "false")
                        {
                            window.location.href="index.html";
                        }
                        else
                        {
                            getBalance();
                        }
                    },
                    error: function()
                    {
                        window.location.href="index.html";   
                    }
                });
            $.ajax
            ({
                url: "/stocks",
                type: "POST", 
                dataType: 'html', 
                data: { username: username }, 
                success: function(result)
                { 
                    if (result == "false")
                    {
                        window.location.href="intro.html";
                    }
                    else
                    {
                        getStocks();
                    }
                },
                error: function()
                {
                    window.location.href="index.html";   
                }
            });
            
            function getBalance()
            {
                $.ajax({
                        url: "/getBalance",
                        type: "POST", 
                        dataType: 'html', 
                        data: { username: username}, 
                        success: function(result)
                        {
                            curBalance.value = result;
                        },
                        error: function()
                        {
                            alert("Failed to obtain balance");   
                        }
                    });
            }

            function addBalance()
            {
                var amount = amounter.value;
                $.ajax({
                        url: "/addBalance",
                        type: "POST", 
                        dataType: 'html', 
                        data: { username: username, amount: amount }, 
                        success: function(result)
                        { 
                            getBalance();
                        },
                        error: function()
                        {
                            alert("Failed to add balance");   
                        }
                    });
            }
            
            function getStocks()
            {
                $.ajax({
                    url: "/getStocks",
                    type: "POST",
                    dataType: 'html',
                    data: { username: username },
                    success: function(result)
                    {
                        drawCharts(result);
                    },
                    error: function()
                    {
                        alert("Failed to get list of stocks!");
                    }
                });
            }

            function updateStockPrices()
            {
                $.ajax({
                    url: "/refreshStockData",
                    type: "POST",
                    dataType: 'html',
                    data: { username: username },
                    success: function()
                    {
                        getStocks();
                    },
                    error: function()
                    {
                        alert("Failed to refresh stock data!");
                    }
                });
            }

            function logout()
            {
                //Set session to cleared.
                sessionStorage.clear();
                window.location.href="index.html";
            }

            function drawCharts(stocksData)
            {
                var data = {
                    datasets: [{
                        data: stocksData,
                        backgroundColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)'
                        ],
                        label: 'Stocks'
                    }],
                    labels: ["stock1", "stock2", "stock3"]
                };

                var options = {
                    responsive: true,
                    animation: {
                        animateRotate: true,
                        animateScale: true
                    }
                };

                var ctx = document.getElementById("pieChartCanvas");
                var pieChart = new Chart(ctx, {
                    type: 'pie',
                    data: data,
                    options: options
                });

                $("#pieChartCanvas").on('click', function(evt) {
                    var activePoints = pieChart.getElementsAtEvent(evt);
                    var firstPoint = activePoints[0];
                    if (firstPoint !== undefined) {
                        data.datasets[firstPoint._datasetIndex].data[firstPoint._index] += parseFloat(incrementAmount.value);
                        pieChart.update();
                    }
                });
                window.pieChartCanvas = pieChart
            }
        </script>
        <div align="top" id="banner"><p align="right"><input type="Submit" id="logout" name="logout" value="Logout" onclick=logout()></p></div>
        <div align="center"><p>Welcome! Please review your stock options.</p></div>
        <div align="center"><p><label>Amount to add to your current account balance: </label><input type="text" id="amounter" name="amounter"></p>
            <p><input type="Submit" value="Submit" onclick=addBalance()></p></div>
        <div align="center">Current account balance</div>
        <div align="center"><input type="text" readonly="readonly" id="curBalance"></div>
        <div align="center">
            <input type="button" value="Refresh Stock Data" onclick="updateStockPrices()"> Data provided for free by <a href="https://iextrading.com/developer">IEX</a>. View <a href="https://iextrading.com/api-exhibit-a/">IEXâ€™s Terms of Use.</a>
        </div>
        <div align="right">
            <p><label>Stock ticker to sell</label><input type="text" id="sellStockerT"></p>
            <p><label>Amount of stock ticker to sell</label><input type="text" id="sellStockerA"></p>
            <p><input type="Submit"></p>
        </div>
        
        <div id="table"></div>
        <div id="pieChartDiv">
            <canvas id="pieChartCanvas" width="50%" height="50%"></canvas>
            <p align="center">Increment: <input type="text" id="incrementAmount" value="1"></p>
        </div>
        <div id="barChartDiv"><canvas id="barChartCanvas"></canvas></div>
    </body>
</html>
